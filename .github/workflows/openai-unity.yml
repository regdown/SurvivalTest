name: OpenAI Unity Automation

on:
  workflow_dispatch:
    inputs:
      task:
        description: '–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –¥–ª—è GPT'
        required: true
        type: string

jobs:
  automate-task:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write helper script
        run: |
          cat > run_gpt.py << 'EOF'
          import os
          import re
          import textwrap
          from openai import OpenAI

          client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
          task = os.getenv("GPT_TASK")

          system_prompt = textwrap.dedent("""\
              –¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ Unity-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞. 
              –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–¥, –≤–æ–∑–≤—Ä–∞—â–∞–π –µ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

              [FILE: –ø—É—Ç—å/–∫/—Ñ–∞–π–ª—É.cs]
              <–∫–æ–¥ —Ñ–∞–π–ª–∞>

              –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –∫–∞–∫–∏–µ-–ª–∏–±–æ –¥–µ–π—Å—Ç–≤–∏—è –≤ Unity (–¥–∞–∂–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã, —Å—Ü–µ–Ω—É, –ø–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫—É –∏ —Ç.–¥.), —Ç—ã **–æ–±—è–∑–∞–Ω –≤–µ—Ä–Ω—É—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª** —Å –∫–æ–¥–æ–º –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏–ª–∏ –≤—Å–µ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–∏—Å—è—Ç –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞ –∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞.
            
              –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –≤–∏–∑—É–∞–ª—É, –≥–µ–π–º–ø–ª–µ—é –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É ‚Äî —Å–æ–∑–¥–∞–π –Ω—É–∂–Ω—ã–µ C# —Å–∫—Ä–∏–ø—Ç—ã, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∏, –ø—Ä–µ—Ñ–∞–±—ã, –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã Unity.

              –î–∞–∂–µ –µ—Å–ª–∏ —Ç—ã –Ω–µ —É–≤–µ—Ä–µ–Ω, —Å–æ–∑–¥–∞–π –∑–∞–≥–ª—É—à–∫—É, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –ø—Ä–∏–º–µ—Ä–Ω—ã–π —à–∞–±–ª–æ–Ω —Å –º–∞–∫—Å–∏–º—É–º –∫–æ–¥–∞. –ù–µ –¥–æ–±–∞–≤–ª—è–π –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown (–Ω–∏–∫–∞–∫–∏—Ö ```csharp –∏ —Ç.–ø.).

              –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–≤–µ—á–∞–π –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω–æ. –¢–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏ –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
          """)

          response = client.chat.completions.create(
              model="gpt-4o",
              messages=[
                  {"role": "system", "content": system_prompt},
                  {"role": "user", "content": task}
              ]
          )

          content = response.choices[0].message.content

          with open("GPT_Response.md", "w", encoding="utf-8") as f:
              f.write(content)

          matches = re.findall(r'\[FILE: (.*?)\]\n(.+?)(?=\n\[FILE: |\Z)', content, flags=re.DOTALL)

          for filepath, code in matches:
            full_path = filepath.strip()
            dir_name = os.path.dirname(full_path)
            if dir_name:
                os.makedirs(dir_name, exist_ok=True)
            with open(full_path, "w", encoding="utf-8") as f:
                f.write(code.strip())
          EOF

      - name: Install dependencies and run GPT
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GPT_TASK: ${{ github.event.inputs.task }}
        run: |
          pip install --upgrade openai
          python3 run_gpt.py

      - name: Commit and create PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto/openai-changes
          title: "ü§ñ GPT Automated code changes"
          commit-message: "üõ†Ô∏è GPT –≤–Ω—ë—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Unity-–ø—Ä–æ–µ–∫—Ç"
          body: "GPT –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–Ω—ë—Å –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç: —Å–º. —Ñ–∞–π–ª GPT_Response.md"
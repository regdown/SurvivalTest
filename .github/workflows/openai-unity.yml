name: OpenAI Unity Automation

on:
  workflow_dispatch:
    inputs:
      task:
        description: '–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –¥–ª—è GPT'
        required: true
        type: string

jobs:
  automate-task:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Request GPT and apply file changes
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          pip install openai
          python3 <<EOF
          import os
          import re
          import openai
          import textwrap

          openai.api_key = os.getenv("OPENAI_API_KEY")

          task = """${{ github.event.inputs.task }}"""

          system_prompt = textwrap.dedent("""\
              –¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ Unity-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞. 
              –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–¥, –≤–æ–∑–≤—Ä–∞—â–∞–π –µ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

              [FILE: –ø—É—Ç—å/–∫/—Ñ–∞–π–ª—É.cs]
              <–∫–æ–¥ —Ñ–∞–π–ª–∞>

              –¢–æ–ª—å–∫–æ —É–∫–∞–∑—ã–≤–∞–π –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –æ–ø–∏—Å–∞–Ω–∏–π. –ù–µ –¥–æ–±–∞–≤–ª—è–π Markdown, —Ç–∞–∫–∏—Ö –∫–∞–∫ ```csharp.
          """)

          response = openai.ChatCompletion.create(
              model="gpt-4o",
              messages=[
                  {"role": "system", "content": system_prompt},
                  {"role": "user", "content": task}
              ]
          )

          content = response['choices'][0]['message']['content']

          with open("GPT_Response.md", "w", encoding="utf-8") as f:
              f.write(content)

          matches = re.findall(r'\[FILE: (.*?)\]\n(.+?)(?=\n\[FILE: |\Z)', content, flags=re.DOTALL)

          for filepath, code in matches:
              full_path = filepath.strip()
              os.makedirs(os.path.dirname(full_path), exist_ok=True)
              with open(full_path, "w", encoding="utf-8") as f:
                  f.write(code.strip())
        EOF

      - name: Commit and create PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto/openai-changes
          title: "ü§ñ GPT Automated code changes"
          commit-message: "üõ†Ô∏è GPT –≤–Ω—ë—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Unity-–ø—Ä–æ–µ–∫—Ç"
          body: "GPT –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–Ω—ë—Å –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç: —Å–º. —Ñ–∞–π–ª GPT_Response.md"

